commonfields:
  id: Joe Security
  version: -1
name: Joe Security
display: Joe Security
category: Forensics & Malware Analysis
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAEHUlEQVR4AezBgQAAAACAoP2pF6kCAAAA5q4egGNJgDAAd2wth/ts27FtZ7B6tq1od0dn27Zt27btK+b+s+33V307Rk93Kv/5pIMALCQCJZQsi4suWlJtz/evLJpayQD9FMQGg+A/kVaw4FhYEzN8RkxM+arlw+Z3NN+T5gi8Hxvf+3ZCSte49u5exnfQYKDPIcvhODgCjoYJQIJ3/8xB6kGNYs2mINu2t4JX9VigP8KpdA/lA3ox0M/5ZgWJgSiYS3jp2OzOJnJ4WoAGiJLABcWX8WMeEGXzAiBkI+hgg2iYD5clDZ3uEf2HnMQr+m2sYhzrVvY3sjoOSgD6I3jZyOFkcy8vabNEr3Uo0A/9aAcyMzrVHk6dWj012TXUDfRdA2mZ2cHd53w6rmX55x08BH6Yhnjn4B7Ba90oqMZGoM+5OqxUQTH7sP8kt3TgWlvbQake1dwo+g88k1fMLbxiLPOoRh4Qp4S3ZjRuKRfU/ZYIqrUbx3o5SV+O5amCor8les1Duc7u7UBsV2SI4N2vj/DzPcjsmLikHdOXnF+b2/9kA9B3DYgjk/pPeOhNT8eOI4noAugD7SthOCQqOsZyVa0pEgMH3S2q+93G+DXFHQxvEmTjLl7WqgTFeEZUrWOYpu1PMQ1b60XFnC3I5hVie3gtEOc3H7IFe7ai62/zqrYJnUU3ItdyUiSAa293d5oL2C79JaZ2PYNj69GxSwnJhO9mWkxc4o7sXbf4snuePBzou5bkdw7d5et73ebbtuOrsXICDwKwIIIbvggvR+YJqvkkHnjH5y+B7uhYHoMvfTzTtO04oM/h+HkoIgDE+Yxbbf7ubSjuckCHIk0o5GKMVhGKvhzIuUg70aPqywRVP9fZtaeOkONgNHydpdGx8euK9EdsOXsffiC759nZQJ+jihVpVTOrj8+p3/ZYWo7kIiILSuHrxMAhMcnp07n27lKM0Qo8fC0KeZGTIydjtB7GV5UwIjWsZHhF736voKgWQTILBdm6SJC0M7C9EYW8YlvYuwNF3AIoRJNxn+sgB/d6A2rQ2VKc+yivGtdleLemEDIfzoCtoMMJUTGxTqDywz4oK9Ref3T0kuOPTC6Qq9tm1F5SU7nqXWfw8CYghIXjwYKNcBIsAhq08NAOFHI0HM92hrqYrv5EdOHzoo7k1P272VbTOVjWgvg7OIYJGpsci8LZGMOD3fKBQU7qVzOqVheJ6v4LgVhveAo+RNDd0ZuAe/RyfmsnoIvmPYKsHwxE+Pl6vHJgDsTQd5Ld+4JnavczrYMk/bgRsn5KZlsoB+hrSBTMh6p/8n+JY5Eui8p+twpSaCgQ4ee3UbQSh3f/UUD/Bbz3oCBGKwD0uc9/9gmftT8HMgAAAACD/K3v8ZVBIiIiIiIiIrOIiIiIiIiISCKI6Et0vPJdAAAAAElFTkSuQmCC
description: Sandbox Cloud
configuration:
- display: API Key
  name: api_key
  defaultvalue: ""
  type: 0
  required: true
- display: Trust any certificate (unsecure)
  name: insecure
  defaultvalue: ""
  type: 8
  required: false
- display: 'Max. Polling Time (in seconds):'
  name: maxpolls
  defaultvalue: "300"
  type: 0
  required: false
- display: 'Verbose (show log in case of error) '
  name: verbose
  defaultvalue: ""
  type: 8
  required: false
script:
  script: |
    ''' IMPORTS '''
    import time
    import shutil
    import requests
    from distutils.util import strtobool
    # disable insecure warnings
    requests.packages.urllib3.disable_warnings()

    ''' GLOBAL VARS '''
    BASE_URL = 'https://jbxcloud.joesecurity.org/api/'
    USE_SSL = not demisto.params().get('insecure', False)
    MAX_POLLS = int(demisto.params().get('maxpolls', 300))

    ''' HELPER FUNCTIONS '''
    def http_post(url_suffix, data=None, files=None, parse_json=True):
        data = {} if data is None else data

        data.setdefault('apikey', demisto.params()['api_key'])
        LOG('running request with url=%s\n\tdata=%s\n\tfiles=%s' % (BASE_URL + url_suffix,
            data, files, ))

        res = requests.post(BASE_URL + url_suffix,
            verify=USE_SSL,
            data=data,
            files=files
        )

        if res.status_code == 403:
            raise Exception('API Key is incorrect')

        if res.status_code != 200:
            LOG('result is: %s' % (res.json(), ))
            error_msg = res.json()['errors'][0]['message']
            raise Exception('Your request failed with the following error: %s.\n%s' % (res.reason, error_msg, ))

        if parse_json:
            return res.json()
        else:
            return res.content


    def analysis_to_entry(title, info):
        if not isinstance(info, list):
            info = [info]

        context = []
        table = []
        dbot_scores = []
        for analysis in info:
            analysis_info = {
                'WebID' : analysis['webid'],
                'SampleName' : analysis['filename'],
                'Status' : analysis['status'],
                'Comments' : analysis['comments'],
                'Time' : analysis['time'],
                'md5' : analysis['md5'],
                'sha1' : analysis['sha1'],
                'sha256' : analysis['sha256'],
                'Systems' : [run['system'] for run in analysis['runs']],
                'Result' : ', '.join([run['detection'] for run in analysis['runs']]),
            }

            analysis_context = dict(analysis_info)
            # # analysis_context['Runs'] = analysis['runs']

            analysis_table = dict(analysis_info)
            # analysis_table['Systems'] =
            analysis_table['Errors'] = [run['error'] for run in analysis['runs']]
            if not any(analysis_table['Errors']):
                analysis_table['Errors'] = None

            dbot_score = 0
            malicious = None
            if 'malicious' in analysis_info['Result']:
                dbot_score = 3
                malicious = {
                    'Vendor' : 'JoeSecurity',
                    'Detections' : ', '.join(set([run['detection'] for run in analysis['runs']])),
                    'SHA1' : analysis_info['sha1'],
                }
            elif 'suspicious' in analysis_info['Result']:
                dbot_score = 2
            elif 'clean' in analysis_info['Result']:
                dbot_score = 1

            dbot_scores.append({
                'Vendor' : 'JoeSecurity',
                'Indicator' : analysis_info['SampleName'],
                'Type' : 'url' if 'md5' is None else 'file',
                'Score' : scoreToReputation(dbot_score),
                'Malicious' : malicious,
            })
            context.append(analysis_context)
            table.append(analysis_table)

        entry = {
            'ContentsFormat': formats['json'],
            'Type': entryTypes['note'],
            'Contents': context,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, table, removeNull=True),
            'EntryContext': {'Joe.Analysis(val.WebID && val.WebID == obj.WebID)' : createContext(context, removeNull=True),
                'DbotScore(val.Vendor && val.Indicator && val.Vendor == obj.Vendor && val.Indicator == obj.Indicator)' :
                    createContext(dbot_scores, removeNull=True),
            }
        }

        return entry


    def poll_webid(web_id):
        result = {'data' : {'status' : 'pending'}}
        max_polls = MAX_POLLS

        while (max_polls >=0) and result['data']['status'] != 'finished':
            if result['data']['status'] != 'pending':
                LOG('error while polling: result is %s' % (result, ))
            result = info_request(web_id)
            time.sleep(1)
            max_polls -= 1

        LOG('reached max_polls #%d' % (max_polls, ))
        if max_polls < 0:
            return analysis_to_entry('Polling timeout on Analysis #' + web_id, result['data'])
        else:
            return analysis_to_entry('Analysis #' + web_id, result['data'])


    ''' FUNCTIONS '''
    def is_online():
        cmd_url = 'v2/server/online'
        res = http_post(cmd_url)
        return res['data']['online']


    def list_analysis():
        cmd_url = 'v2/analysis/list'
        res = http_post(cmd_url)

        data = [info_request(web_id['webid'])['data'] for web_id in res['data']]
        return analysis_to_entry('All Analyses:', data)


    def analysis_info():
        web_id = demisto.args().get('webid')
        LOG('info: web_id = %s' % (web_id, ))
        res = info_request(web_id)

        return analysis_to_entry('Analysis #' + web_id, res['data'])


    def info_request(web_id):
        cmd_url = 'v2/analysis/info'
        return http_post(cmd_url, data={'webid' : web_id})


    def search():
        cmd_url = 'v2/analysis/search'
        query = demisto.args().get('query')
        res = http_post(cmd_url, data={'q':query})
        if len(res['data']) == 0:
            return 'No Result was found.'

        data = [info_request(web_id['webid'])['data'] for web_id in res['data']]
        return analysis_to_entry('Analysis Search Results:', data)


    def analyse_url():
        args = demisto.args()
        url = args.get('url')
        internet_access = bool(strtobool(args.get('internet-access', 'true')))
        comments = args.get('comments')
        systems = args.get('systems')

        should_wait = bool(strtobool(demisto.get(args, 'should_wait')))

        return analyse_url_request(url, should_wait, internet_access, comments, systems)


    def analyse_url_request(url, should_wait, internet_access, comments=None, systems=None):
        data = {
            'accept-tac': 1,
            'url' : url,
            'internet-access' : 1 if internet_access else 0,
        }
        if comments is not None:
            data['comments'] = comments
        if systems is not None:
            data['systems[]'] = [s.strip() for s in systems.split(',')]
        res = http_post('v2/analysis/submit',
            data=data)

        if 'errors' in res:
            LOG('Error! in command analyse_url: url=%s' % (url, ))
            LOG('got the following errors:\n' + '\n'.join(e['message'] for e in res['errors']))
            raise Exception('command failed to run.')

        if should_wait:
            return poll_webid(res['data']['webids'][0])

        web_id = res['data']['webids'][0]
        result = info_request(web_id)
        return analysis_to_entry('Analysis #%s' % (web_id, ), result['data'])


    def analyse_sample():
        args = demisto.args()
        file_entry = args.get('file_id')
        sample_url = args.get('sample_url')
        internet_access = bool(strtobool(args.get('internet-access', 'true')))
        should_wait = bool(strtobool(demisto.get(args, 'should_wait')))
        comments = args.get('comments')
        systems = args.get('systems')

        if (file_entry is None and sample_url is None) or (None not in [file_entry, sample_url]):
            raise ValueError('You must specify one (and only one) of the following: sample_url, file_id.')

        LOG('analysing sample')
        if file_entry is not None:
            return analyse_sample_file_request(file_entry, should_wait, internet_access, comments, systems)
        else:
            return analyse_sample_url_request(sample_url, should_wait, internet_access, comments, systems)


    def analyse_sample_file_request(file_entry, should_wait, internet_access, comments=None, systems=None):
        data = {
            'accept-tac': 1,
            'internet-access' : 1 if internet_access else 0,
        }
        if comments is not None:
            data['comments'] = comments
        if systems is not None:
            data['systems[]'] = [s.strip() for s in systems.split(',')]

        shutil.copy(demisto.getFilePath(file_entry)['path'],
            demisto.getFilePath(file_entry)['name'])

        with open(demisto.getFilePath(file_entry)['name'], 'rb') as f:
            res = http_post('v2/analysis/submit',
                data=data,
                files={'sample':f})

            if 'errors' in res:
                LOG('Error! in command sample file: file_entry=%s' % (file_entry, ))
                LOG('got the following errors:\n' + '\n'.join(e['message'] for e in res['errors']))
                raise Exception('command failed to run.')

        shutil.rmtree(demisto.getFilePath(file_entry)['name'], ignore_errors=True)

        if should_wait:
            return poll_webid(res['data']['webids'][0])

        web_id = res['data']['webids'][0]
        result = info_request(web_id)
        return analysis_to_entry('Analysis #%s' % (web_id, ), result['data'])


    def analyse_sample_url_request(sample_url, should_wait, internet_access, comments, systems):
        data = {
            'accept-tac': 1,
            'sample-url' : sample_url,
            'internet-access' : 1 if internet_access else 0,
        }
        if comments is not None:
            data['comments'] = comments
        if systems is not None:
            data['systems[]'] = [s.strip() for s in systems.split(',')]

        res = http_post('v2/analysis/submit', data=data)

        if 'errors' in res:
            LOG('Error! in command sample file: file url=%s' % (sample_url, ))
            LOG('got the following errors:\n' + '\n'.join(e['message'] for e in res['errors']))
            raise Exception('command failed to run.')

        if should_wait:
            return poll_webid(res['data']['webids'][0])

        web_id = res['data']['webids'][0]
        result = info_request(res['data']['webids'][0])
        return analysis_to_entry('Analysis #%s' % (web_id, ), result['data'])


    def download_report():
        args = demisto.args()
        webid = args.get('webid')
        rsc_type = args.get('type')
        return download_request(webid, rsc_type)


    def download_sample():
        args = demisto.args()
        webid = args.get('webid')
        rsc_type = 'sample'
        return download_request(webid, rsc_type)


    def download_request(webid, rsc_type):
        res = http_post('v2/analysis/download',
            data={'webid': webid,
                'type' : rsc_type.lower(),
            },
            parse_json=False)

        if rsc_type == 'sample':
            return fileResult('%s_sample.dontrun' % (webid, ), res)
        else:
            return fileResult('%s_report.%s' % (webid, rsc_type, ), res)


    ''' EXECUTION CODE '''
    LOG('command is %s' % (demisto.command(), ))
    try:
        if demisto.command() in ['test-module', 'joe-is-online']:
            # This is the call made when pressing the integration test button.
            if is_online():
                demisto.results('ok')
            else:
                demisto.results('not online')
        elif demisto.command() == 'joe-list-analysis':
            demisto.results(list_analysis())
        elif demisto.command() == 'joe-analysis-info':
            demisto.results(analysis_info())
        elif demisto.command() == 'joe-analysis-submit-url':
            demisto.results(analyse_url())
        elif demisto.command() == 'joe-analysis-submit-sample':
            demisto.results(analyse_sample())
        elif demisto.command() == 'joe-download-report':
            demisto.results(download_report())
        elif demisto.command() == 'joe-download-sample':
            demisto.results(download_sample())
        elif demisto.command() == 'joe-search':
            demisto.results(search())

    except Exception, e:
        if demisto.params().get('verbose'):
            LOG(e.message)
            if demisto.command() != 'test-module':
                LOG.print_log()

        demisto.results({
            'Type': entryTypes['error'],
            'ContentsFormat': formats['text'],
            'Contents': 'error has occured: %s' % (e.message, ),
        })
  type: python
  commands:
  - name: joe-is-online
    arguments: []
    description: Check if Joe Sandbox is online or in maintenance mode.
  - name: joe-analysis-submit-url
    arguments:
    - name: url
      required: true
      default: true
      description: sample url
    - name: should_wait
      auto: PREDEFINED
      predefined:
      - "True"
      - "False"
      description: Should the command poll for the result of the analysis
      defaultValue: "False"
    - name: comments
      description: 'Comments for the analysis '
    - name: systems
      description: 'Operating System to run analysis on(comma separated). possible
        values are: w7, w7x64, w7_1, w7_2, w7native, android2, android3, mac1, w7l,
        w7x64l, w10, android4, w7x64native, w7_3, w10native, android5native_1, w7_4,
        w7_5, w10x64, w7x64_hvm, android6, iphone1, w7_sec, macvm, w7_lang_packs,
        w7x64native_hvm, lnxubuntu1, lnxcentos1, android7_nougat'
      defaultValue: w7x64
    - name: internet-access
      auto: PREDEFINED
      predefined:
      - "True"
      - "False"
      description: Enable full internet access. Default is True
      defaultValue: "True"
    outputs:
    - contextPath: Joe.Analysis.WebID
      description: Web ID
      type: string
    - contextPath: Joe.Analysis.SampleName
      description: Sample Data, could be a file name or URL
      type: string
    - contextPath: Joe.Analysis.Status
      description: Analysis Status
      type: string
    - contextPath: Joe.Analysis.Comments
      description: Analysis Comments
      type: string
    - contextPath: Joe.Analysis.Time
      description: Submitted Time
      type: date
    - contextPath: Joe.Analysis.Runs
      description: Application used for analysis
    - contextPath: Joe.Analysis.Result
      description: Analysis Results
      type: unknown
    - contextPath: Joe.Analysis.RunErrors
      description: Raised errors during sampling
    - contextPath: Joe.Analysis.RunSystems
      description: Analysis OS
    - contextPath: Joe.Analysis.md5
      description: MD5 of analysis sample
      type: string
    - contextPath: Joe.Analysis.sha1
      description: sha1 of analysis sample
      type: string
    - contextPath: Joe.Analysis.sha256
      description: sha256 of analysis sample
      type: string
    description: Submit a url for analysis.
  - name: joe-analysis-info
    arguments:
    - name: webid
      required: true
      default: true
      description: Web ID
    outputs:
    - contextPath: Joe.Analysis.WebID
      description: Web ID
    - contextPath: Joe.Analysis.SampleName
      description: Sample Data, could be a file name or URL
      type: string
    - contextPath: Joe.Analysis.Status
      description: Analysis Status
      type: string
    - contextPath: Joe.Analysis.Comments
      description: Analysis Comments
      type: string
    - contextPath: Joe.Analysis.Time
      description: Submitted Time
      type: date
    - contextPath: Joe.Analysis.Runs
      description: Application used for analysis
    - contextPath: Joe.Analysis.Result
      description: Analysis Results
    description: Show information about an analysis.
  - name: joe-list-analysis
    arguments: []
    outputs:
    - contextPath: Joe.Analysis.WebID
      description: Web ID
      type: string
    description: List all analyses.
  - name: joe-analysis-submit-sample
    arguments:
    - name: file_id
      default: true
      description: War Room entry of a file (for example, 3245@4)
    - name: sample_url
      description: Url to a sample file
    - name: should_wait
      auto: PREDEFINED
      predefined:
      - "True"
      - "False"
      description: Should the command poll for the result of the analysis
      defaultValue: "False"
    - name: comments
      description: Comments for the analysis
    - name: systems
      description: 'Operating System to run analysis on(comma separated). possible
        values are: w7, w7x64, w7_1, w7_2, w7native, android2, android3, mac1, w7l,
        w7x64l, w10, android4, w7x64native, w7_3, w10native, android5native_1, w7_4,
        w7_5, w10x64, w7x64_hvm, android6, iphone1, w7_sec, macvm, w7_lang_packs,
        w7x64native_hvm, lnxubuntu1, lnxcentos1, android7_nougat'
    - name: internet-access
      auto: PREDEFINED
      predefined:
      - "True"
      - "False"
      description: Enable full internet access. Default is True
      defaultValue: "True"
    outputs:
    - contextPath: Joe.Analysis.WebID
      description: Web ID
    - contextPath: Joe.Analysis.SampleName
      description: Sample Data, could be a file name or URL
    - contextPath: Joe.Analysis.Status
      description: Analysis Status
    - contextPath: Joe.Analysis.Comments
      description: Analysis Comments
    - contextPath: Joe.Analysis.Time
      description: Submitted Time
    - contextPath: Joe.Analysis.Runs
      description: Application used for analysis
    - contextPath: Joe.Analysis.Result
      description: Analysis Results
    description: Submit a sample for analysis.
  - name: joe-download-report
    arguments:
    - name: webid
      required: true
      default: true
      description: Web ID
    - name: type
      auto: PREDEFINED
      predefined:
      - html
      - json
      - pcap
      - pdf
      - xml
      description: The resource type to download. Defaults to html.
      defaultValue: html
    description: Download a resource belonging to a report. This can be the full report,
      dropped binaries, etc.
  - name: joe-search
    arguments:
    - name: query
      required: true
      default: true
      description: 'Search string which will search in the following fields only:
        webid, md5, sha1, sha256, filename, URL, comments.'
    outputs:
    - contextPath: Joe.Analysis.WebID
      description: Web ID
      type: string
    description: Search through all analyses.
  - name: joe-download-sample
    arguments:
    - name: webid
      required: true
      default: true
      description: Web ID
    description: Download the sample file of an analysis. for security reasons, the
      extension will be "dontrun"
  runonce: false
releaseNotes: "-"